<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mô phỏng Sự cố & So sánh (Simulate & Compare)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #f0f2f5; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); overflow: hidden; }
        
        /* Header */
        .header-bar { background: linear-gradient(135deg, #0050b3, #003a8c); color: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; }
        .header-bar h2 { margin: 0; font-size: 1.4em; }

        /* Control Panel */
        .control-panel { padding: 20px 25px; background: #e6f7ff; border-bottom: 1px solid #bae7ff; display: flex; gap: 20px; align-items: flex-end; }
        .form-group { flex: 1; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; color: #003a8c; font-size: 0.95em; }
        select, input[type="file"] { width: 100%; padding: 8px 12px; border: 1px solid #d9d9d9; border-radius: 4px; box-sizing: border-box; background: white; }
        
        .btn-run { 
            background: #d4380d; color: white; border: none; padding: 0 30px; height: 38px; 
            border-radius: 4px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 10px; 
            transition: all 0.3s; box-shadow: 0 2px 5px rgba(212, 56, 13, 0.3);
        }
        .btn-run:hover { background: #ff4d4f; transform: translateY(-1px); }
        .btn-run:active { transform: translateY(0); }

        /* Info Bar */
        .info-bar { padding: 10px 25px; background: #fffbe6; border-bottom: 1px solid #ffe58f; color: #d48806; font-size: 0.9em; display: flex; gap: 20px; align-items: center; }

        /* Main Layout */
        .main-content { display: flex; height: 650px; }
        
        /* Sidebar Delta */
        .sidebar { width: 360px; border-right: 1px solid #eee; display: flex; flex-direction: column; background: #fafafa; }
        .sb-header { padding: 12px 15px; font-weight: bold; background: #fff1f0; color: #cf1322; border-bottom: 1px solid #ffccc7; display: flex; align-items: center; gap: 8px; }
        .delta-list { flex: 1; overflow-y: auto; padding: 0; margin: 0; list-style: none; }
        
        /* Item Style */
        .delta-item { padding: 12px 15px; border-bottom: 1px solid #eee; cursor: pointer; background: white; transition: background 0.2s; border-left: 4px solid transparent; }
        .delta-item:hover { background: #e6f7ff; }
        .delta-item.active { background: #e6f7ff; border-left-color: #1890ff !important; } /* Active đè lên màu cảnh báo */
        
        /* MÀU CẢNH BÁO */
        .item-critical { background-color: #fff1f0; border-left-color: #cf1322; } /* Đỏ > 100% */
        .item-warning { background-color: #fff7e6; border-left-color: #fa8c16; }  /* Cam > 90% */

        .delta-info { display: flex; justify-content: space-between; align-items: center; margin-top: 6px; font-size: 0.85em; color: #666; }
        .d-val { padding: 2px 6px; border-radius: 4px; font-weight: 700; font-size: 1.1em; }
        .inc { color: #389e0d; } 
        .dec { color: #cf1322; }
        
        .sub-val { font-size: 0.85em; color: #555; font-weight: normal; margin-left: 5px; }

        /* Chart Area */
        .chart-area { flex: 1; padding: 20px; display: flex; flex-direction: column; background: white; }
        .chart-toolbar { display: flex; gap: 15px; margin-bottom: 15px; }
        
        /* Loading Overlay */
        #loading { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 9999; justify-content: center; align-items: center; flex-direction: column; }
        
        /* Progress Bar Style */
        .progress-box { width: 300px; height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden; margin: 15px 0; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #1890ff, #40a9ff); width: 0%; transition: width 0.3s ease; }
    </style>
</head>
<body>

<div id="loading">
    <i class="fas fa-microchip fa-spin" style="font-size: 40px; color: #1890ff; margin-bottom: 15px;"></i>
    <h3 style="color: #333; margin: 0;">Đang xử lý mô phỏng...</h3>
    <div class="progress-box">
        <div id="progressBar" class="progress-bar"></div>
    </div>
    <p id="progressText" style="color: #666; font-size: 0.9em;">Đang khởi tạo...</p>
</div>

<div class="container">
    <div class="header-bar">
        <h2><i class="fas fa-project-diagram"></i> Mô phỏng Sự cố & So sánh (Simulate & Compare)</h2>
    </div>

    <div class="control-panel">
        <div class="form-group" style="flex: 2;">
            <label>1. Chọn Ngày dữ liệu (Nền)</label>
            <select id="folderSelect"><option>Đang tải danh sách...</option></select>
        </div>
        <div class="form-group" style="flex: 2;">
            <label>2. Upload Script Công tác(.py)</label>
            <input type="file" id="scriptFile" accept=".py">
        </div>
        <button class="btn-run" onclick="runSimulation()">
            <i class="fas fa-play"></i> CHẠY MÔ PHỎNG
        </button>
    </div>

    <div class="info-bar">
        <span id="stStatus"><i class="fas fa-info-circle"></i> Vui lòng chọn ngày và file script để bắt đầu.</span>
    </div>

    <div class="main-content">
        <aside class="sidebar">
            <div class="sb-header"><i class="fas fa-exclamation-triangle"></i> Biến động trào lưu công suất (>1%)</div>
            <ul id="deltaList" class="delta-list">
                <li style="padding:20px; text-align:center; color:#999">Chưa có kết quả phân tích</li>
            </ul>
        </aside>

        <main class="chart-area">
            <div class="chart-toolbar">
                <div style="flex: 3;">
                    <select id="branchSelect" style="width: 100%;"></select>
                </div>
                <div style="flex: 1;">
                    <select id="metricSelect" style="width: 100%; height: 38px; border-radius: 4px; border: 1px solid #aaa; padding: 5px;">
                        <option value="mw" selected>P (MW)</option>
                        <option value="pctmva">% Mang tải (S)</option>
                        <option value="amps">Dòng điện (A)</option>
                    </select>
                </div>
            </div>
            <div style="flex: 1; position: relative; border: 1px solid #eee; border-radius: 8px; padding: 10px;">
                <canvas id="myChart"></canvas>
            </div>
        </main>
    </div>
</div>

<script>
    let globalData = { file1: null, file2: null, delta: null };
    let myChart = null;
    let progressInterval = null;

    $(document).ready(function() {
        loadFolders();
        $('#branchSelect').select2({ placeholder: "Chọn thiết bị...", width: '100%' });

        $('#branchSelect').on('change', function() {
            var val = $(this).val();
            if(val) drawChart(val);
        });

        $('#metricSelect').change(function() { 
            drawChart($('#branchSelect').val()); 
        });
    });

    // --- HÀM PROGRESS BAR (Giả lập để người dùng biết đang chạy) ---
    function startProgress() {
        let width = 0;
        const bar = document.getElementById('progressBar');
        const txt = document.getElementById('progressText');
        $('#loading').css('display', 'flex');
        
        progressInterval = setInterval(() => {
            if (width >= 90) {
                // Giữ ở 90% nếu server chưa trả về
            } else {
                // Tăng ngẫu nhiên để tạo cảm giác thực
                width += Math.random() * 3; 
                bar.style.width = width + '%';
                txt.innerText = `Đang tính toán Power Flow... ${Math.round(width)}%`;
            }
        }, 300); // Cập nhật mỗi 300ms
    }

    function stopProgress() {
        clearInterval(progressInterval);
        document.getElementById('progressBar').style.width = '100%';
        document.getElementById('progressText').innerText = 'Hoàn tất! Đang vẽ đồ thị...';
        setTimeout(() => {
            $('#loading').hide();
            document.getElementById('progressBar').style.width = '0%'; // Reset
        }, 500);
    }

    async function loadFolders() {
        try {
            const res = await fetch('/get_folders');
            const list = await res.json();
            const sel = document.getElementById('folderSelect');
            sel.innerHTML = "";
            list.forEach(f => {
                const opt = document.createElement('option');
                opt.value = f; opt.text = f;
                sel.appendChild(opt);
            });
        } catch (e) { alert("Lỗi kết nối Server! Hãy chắc chắn server.py đang chạy."); }
    }

    async function runSimulation() {
        const date = document.getElementById('folderSelect').value;
        const file = document.getElementById('scriptFile').files[0];
        
        if(!date) return alert("Vui lòng chọn ngày dữ liệu!");
        
        const formData = new FormData();
        formData.append('date', date);
        if(file) formData.append('script_file', file);

        // Bắt đầu hiệu ứng loading
        startProgress();
        
        try {
            const res = await fetch('/run_simulation_compare', { method: 'POST', body: formData });
            const json = await res.json();

            if (json.status === 'success') {
                globalData = json.payload;
                document.getElementById('stStatus').innerHTML = `<i class="fas fa-check-circle" style="color:green"></i> ${json.message}`;
                updateBranchDropdown();
                renderDeltaList();
            } else {
                alert("Lỗi Server: " + json.message);
                document.getElementById('stStatus').innerText = "Có lỗi xảy ra: " + json.message;
            }
        } catch (e) {
            alert("Lỗi kết nối API: " + e);
        } finally {
            // Kết thúc hiệu ứng loading
            stopProgress();
        }
    }

    function renderDeltaList() {
        const ul = document.getElementById('deltaList');
        ul.innerHTML = "";
        
        const deltas = Object.entries(globalData.delta || {}).map(([k,v]) => ({id:k, ...v}));
        
        // Sắp xếp theo trị tuyệt đối
        deltas.sort((a,b) => {
            const valA = parseFloat(a.delta.replace('%',''));
            const valB = parseFloat(b.delta.replace('%',''));
            return Math.abs(valB) - Math.abs(valA);
        });

        if(deltas.length === 0) {
            ul.innerHTML = '<li style="padding:20px; text-align:center">Không có thay đổi nào đáng kể (>1%).</li>'; return;
        }

        deltas.forEach(item => {
            let rawVal = parseFloat(item.delta.replace('%', ''));
            let sign = rawVal > 0 ? '+' : ''; 
            let cleanDelta = sign + Math.abs(rawVal).toFixed(2) + '%';
            const isInc = rawVal > 0; 
            
            // Lấy giá trị Pct After từ server gửi về
            let pctAfter = item.pct_after !== undefined ? parseFloat(item.pct_after) : 0;
            
            // Xử lý Class màu sắc (Goal 3)
            let colorClass = '';
            if (pctAfter >= 100) colorClass = 'item-critical';      // Đỏ
            else if (pctAfter >= 90) colorClass = 'item-warning';   // Cam

            const li = document.createElement('li');
            li.className = `delta-item ${colorClass}`; // Áp dụng class
            
            // HTML hiển thị (Goal 4)
            li.innerHTML = `
                <div style="font-weight:600; font-size: 0.9em; margin-bottom: 5px;">${item.name}</div>
                <div class="delta-info">
                    <span><i class="far fa-clock"></i> ${item.at}</span>
                    <div>
                        <span class="d-val ${isInc ? 'inc' : 'dec'}">${cleanDelta}</span>
                        <span class="sub-val">(${pctAfter.toFixed(1)}%)</span>
                    </div>
                </div>
            `;
            
            li.onclick = () => {
                $('.delta-item').removeClass('active');
                li.classList.add('active');
                $('#branchSelect').val(item.id).trigger('change');
            };
            ul.appendChild(li);
        });
    }

    function updateBranchDropdown() {
        const keys = new Set([...Object.keys(globalData.file1 || {}), ...Object.keys(globalData.file2 || {})]);
        const data = Array.from(keys).map(k => {
            const name = (globalData.file1[k] && globalData.file1[k].name) || k;
            return { id: k, text: `${name} (${k})` };
        });
        
        $('#branchSelect').empty().select2({ data: data, placeholder: "Chọn thiết bị...", width: '100%' });
        const firstDelta = document.querySelector('.delta-item');
        if(firstDelta) firstDelta.click();
    }

    function drawChart(branchId) {
        if(!branchId) return;
        const metric = document.getElementById('metricSelect').value;
        const ctx = document.getElementById('myChart').getContext('2d');

        const extract = (source) => {
            if(!source || !source[branchId]) return { times:[], values:[], rates:[] };
            const flows = source[branchId].flows;
            const times = Object.keys(flows).sort();
            return {
                times: times.map(t => t.split(' ')[1]),
                values: times.map(t => flows[t][metric]),
                rates: times.map(t => flows[t]['rate'])
            };
        };

        const dMod = extract(globalData.file1); // Có Script
        const dBase = extract(globalData.file2); // Gốc
        const labels = dMod.times.length ? dMod.times : dBase.times;

        // Xử lý Rate linh hoạt
        let maxAbs = 0; let direction = 1;
        [...dMod.values, ...dBase.values].forEach(v => {
            if(v !== undefined && Math.abs(v) > maxAbs) {
                maxAbs = Math.abs(v);
                direction = v < 0 ? -1 : 1;
            }
        });
        const adjustedRates = dBase.rates.map(r => r ? Math.abs(r) * direction : null);
        const overloadColor = 'rgba(255, 77, 79, 0.4)';

        if(myChart) myChart.destroy();

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Khi thực hiện công tác',
                        data: dMod.values,
                        borderColor: '#ff4d4f',
                        backgroundColor: 'rgba(255, 77, 79, 0.1)',
                        borderWidth: 2,
                        tension: 0.2,
                        fill: {
                            target: 2, 
                            above: direction === 1 ? overloadColor : 'transparent',
                            below: direction === -1 ? overloadColor : 'transparent'
                        }
                    },
                    {
                        label: 'Vận hành bình thường',
                        data: dBase.values,
                        borderColor: '#52c41a',
                        borderWidth: 2,
                        borderDash: [5,5],
                        tension: 0.2,
                        fill: false
                    },
                    {
                        label: `Rate (Định mức ${direction === 1 ? '+' : '-'})`,
                        data: adjustedRates,
                        borderColor: '#333',
                        borderWidth: 1.5,
                        borderDash: [2,2],
                        pointRadius: 0,
                        fill: false,
                        hidden: metric === 'pctmva'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    title: { display: true, text: `Biểu đồ: ${branchId}` },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) label += ': ';
                                if (context.parsed.y !== null) label += context.parsed.y.toFixed(2);
                                return label;
                            }
                        }
                    },
                    filler: { propagate: false }
                },
                scales: { x: { ticks: { maxTicksLimit: 24 } } }
            }
        });
    }
</script>

</body>
</html>